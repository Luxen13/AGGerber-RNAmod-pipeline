// nextflow.config
//TODO: upate manifest
// manifest {
//     name = 'your-github-username/your-pipeline-name'
//     author = 'Your Name'
//     homePage = 'https://github.com/your-github-username/your-pipeline-name'
//     description = 'A short, clear description of what the pipeline does.'
//     mainScript = 'main.nf'
//     nextflowVersion = '>=22.10.0' // 
//     version = '1.0.0'
// }


// Default parameters
params {
    cpus = 4
    use_gpu = 'cuda:all'  // GPU specification: 'cuda:all', 'cuda:0', 'cuda:0,1', etc.
    //aws_queue = null
    //aws_region = 'us-east-1'
}

// Global process defaults
process {
    cpus = { params.cpus }
    
    // Container definitions
    withName: 'DORADO_BASECALL' {
        container = 'ontresearch/dorado:shae423e761540b9d08b526a1eb32faf498f32e8f22'
        containerOptions = '--gpus all'  // GPU access for Docker container
    }
    withName: 'MINIMAP2_ALIGN_GENOME' {
        container = 'nanozoo/minimap2:2.28--9e3bd01'
    }
    withName: 'MINIMAP2_ALIGN_TRANSCRIPTOME' {
        container = 'nanozoo/minimap2:2.28--9e3bd01'
    }
    withName: 'MODKIT_PILEUP_GENOME' {
        container = 'ontresearch/modkit:shaa7bf2b62946eeb7646b9b9d60b892edfc3b3a52c'
    }
    withName: 'MODKIT_PILEUP_TRANSCRIPTOME' {
        container = 'ontresearch/modkit:shaa7bf2b62946eeb7646b9b9d60b892edfc3b3a52c'
    }
    withName: 'MODKIT_TRANSCRIPTOME_ACCELERATION' {
        container = 'luxendr13/modkit-accelerated:latest'
    }    
    withName: 'SALMON_QUANT' {
        container = 'combinelab/salmon:1.10.3'
    }
    withName: 'FEATURECOUNTS_GENOME' {
        container = 'nanozoo/subread:2.0.2--53f5da6'
    }

    withName: 'NANOCOMP' {
        container = 'luxendr13/nanocomp:0.5.0'
    }
}

profiles {
    // Default profile - uses Docker
    standard {
        docker {
            enabled = true
            runOptions = "--user \$(id -u):\$(id -g) --group-add 100"
        }
    }
 
    // Singularity profile
    singularity {
        singularity {
            enabled = true
            autoMounts = true
        }
    }
 
    // keep stub conda profile to prevent unknown profile warning so users get a better error
    conda {
        conda.enabled = true
    }
 
    // AWS Batch profile,
    // May need to set aws.region and aws.batch.cliPath
    awsbatch {
        //aws.region = params.aws_region
        //aws.batch.cliPath = '/home/ec2-user/miniconda/bin/aws'
        
        process {
            executor = 'awsbatch'
            queue = params.aws_queue
            memory = '64G'
            shell = ['/bin/bash', '-euo', 'pipefail']
            
            // GPU settings for Dorado on AWS Batch
            withName: 'DORADO_BASECALL' {
                containerOptions = "-e NVIDIA_DRIVER_CAPABILITIES=compute,utility --gpus all"
            }
        }
    }
 
    // Development: fast feedback, no containers (ONLY if tools installed locally)
    dev {
        process.executor = 'local'
        docker.enabled = false
        singularity.enabled = false
    }
}
